![[Pasted image 20240518180238.png]]

---
![[Pasted image 20240518180344.png]]
![[Pasted image 20240518180410.png]]
![[Pasted image 20240518180441.png]]

```json
{
  "name": "twittr",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "dev": "node --watch index.js",
    "test": "jest --watchAll"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@hapi/boom": "^10.0.1",
    "@hapi/joi": "^17.1.1",
    "dotenv": "^16.1.3",
    "express": "^4.18.2",
    "mysql2": "^3.3.3"
  },
  "devDependencies": {
    "jest": "^29.5.0"
  }
}

```

---
![[Pasted image 20240518180554.png]]
![[Pasted image 20240518180604.png]]

---
![[Pasted image 20240518180701.png]]
![[Pasted image 20240518180711.png]]

```js
const boom = require("@hapi/boom");
const withErrorStack = require("../withErrorStack");

function logErrors(err, req, res, next) {
  console.error(err);
  next(err);
}

function wrapErrors(err, req, res, next) {
  if (!err.isBoom) {
    next(boom.badImplementation(err));
  }

  next(err);
}

function errorHandler(err, req, res, next) {
  const { stack, output } = err;
  res.status(output.statusCode);
  res.json(withErrorStack(output.payload, stack));
}

module.exports = {
  logErrors,
  wrapErrors,
  errorHandler,
};
```

---
![[Pasted image 20240518180801.png]]
![[Pasted image 20240518180817.png]]
```js
const config = require("../config");

function withErrorStack(error, stack, _isStackShown = config.dev) {
  if (_isStackShown) {
    return { ...error, stack };
  }
  return error;
}

module.exports = withErrorStack;

```


---
![[Pasted image 20240518181048.png]]
```js
const boom = require("@hapi/boom");
const withErrorStack = require("../withErrorStack");

function logErrors(err, req, res, next) {
  console.error(err);
  next(err);
}

function wrapErrors(err, req, res, next) {
  if (!err.isBoom) {
    next(boom.badImplementation(err));
  }

  next(err);
}

function errorHandler(err, req, res, next) {
  const { stack, output } = err;
  res.status(output.statusCode);
  res.json(withErrorStack(output.payload, stack));
}

module.exports = {
  logErrors,
  wrapErrors,
  errorHandler,
};
```

---
![[Pasted image 20240518181142.png]]
![[Pasted image 20240518181345.png]]
![[Pasted image 20240518181632.png]]
![[Pasted image 20240518181707.png]]

---
```js
const withErrorStack = require("./withErrorStack");

describe("[ utils / withErrorStack ]", () => {
  it("should return the error with stack", () => {
    // Arrange
    const error = { message: "Error" };
    const stack = { TypeError: "Line 32" };
    const expected = { message: "Error", stack: { TypeError: "Line 32" } };

    // Act
    const result = withErrorStack(error, stack, true);

    // Assert
    expect(result).toEqual(expected);
  });

  it("should return the error without stack", () => {
    // Arrange
    const error = { message: "Error" };
    const stack = { TypeError: "Line 32" };
    const expected = { message: "Error" };

    // Act
    const result = withErrorStack(error, stack, false);

    // Assert
    expect(result).toEqual(expected);
  });
});

```


---
![[Pasted image 20240518181726.png]]
![[Pasted image 20240518181732.png]]
